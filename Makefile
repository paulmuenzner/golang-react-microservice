# ==========================================
# Environment Variables (aus .env laden)
# ==========================================
include .env
export

.PHONY: help init dev dev-a dev-b dev-g test lint prod prod-up prod-stop stop clean delete stat info storage

.DEFAULT_GOAL := help

# ==========================================
# Utility Commands
# ==========================================

help: ## Show this help message
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "Available Commands:"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-25s\033[0m %s\n", $$1, $$2}'
	@echo ""

clean: ## Clean all containers, volumes, and images
	@echo "üßπ Cleaning up..."
	@podman-compose -f docker-compose.yml down -v
	@podman-compose -f docker-compose.migrate.yml down -v
	@podman-compose -f docker-compose.prod.yml down -v
	@echo "‚úÖ Cleanup complete"

install-tools: ## Install development tools (golangci-lint, air)
	@echo "üîß Installing development tools..."
	@which golangci-lint > /dev/null || { \
		echo "  ‚Üí Installing golangci-lint..."; \
		go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest; \
	}
	@which air > /dev/null || { \
		echo "  ‚Üí Installing air..."; \
		go install github.com/air-verse/air@latest; \
	}
	@echo "‚úÖ All tools installed!"


init: ## Initialize Go modules for all services
	@echo "üîß Initializing (Go ${GO_VERSION})..."
	@cd shared/go && go mod tidy
	@cd app/backend/service-a && go mod tidy
	@cd app/backend/service-b && go mod tidy
	@cd app/backend/gateway && go mod tidy
	@echo "‚úÖ Initialization complete!"

lint: ## Run golangci-lint on all Go code
	@echo "üîç Running linters..."
	@cd shared/go && golangci-lint run
	@cd app/backend/service-a && golangci-lint run
	@cd app/backend/service-b && golangci-lint run
	@cd app/backend/gateway && golangci-lint run
	@echo "‚úÖ Linting complete!"
	

.PHONY: dev dev-up dev-down dev-logs dev-logs-gateway dev-restart \
        db-migrate db-status db-tables db-connect db-migrations-list db-test db-clean \
        prod-build prod-migrate prod-backup prod-deploy prod-up prod-down prod-logs prod-status prod-restart prod-rebuild \
        help clean install-tools init lint

.DEFAULT_GOAL := help





# ==========================================
# Development Commands
# ==========================================

dev: db-migrate dev-up ## Start development environment (migration first, then services)
	@echo ""
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "‚úÖ Development environment ready!"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "üìç Gateway:  http://localhost:$(PORT_GATEWAY)"
	@echo "üìç Grafana:  http://localhost:$(PORT_GRAFANA) (admin/admin)"
	@echo ""

dev-up: ## Start development services (without migrations)
	@echo "üê≥ Starting development services..."
	@podman-compose -f docker-compose.yml up -d
	@echo "‚è≥ Waiting for services to be healthy..."
	@sleep 5
	@echo "‚úÖ Services running"

dev-down: ## Stop development services
	@echo "üõë Stopping development services..."
	@podman-compose -f docker-compose.yml down
	@echo "‚úÖ Services stopped"

dev-logs: ## Show logs from all services
	@podman-compose -f docker-compose.yml logs -f

dev-logs-gateway: ## Show gateway logs only
	@podman-compose -f docker-compose.yml logs -f gateway

dev-restart: ## Restart development environment
	@$(MAKE) dev-down
	@$(MAKE) dev

dev-quiet: ## Start services without logging stack logs
	@echo "üê≥ Starting logging stack in background..."
	podman-compose up -d loki promtail grafana
	@sleep 5
	@echo "üê≥ Starting services with logs..."
	podman-compose up gateway service-a service-b

stop: ## Stop development containers
	@echo "üõë Stopping development services..."
	podman-compose stop
	@echo "‚úÖ Development services stopped!"


# ==========================================
# Production Commands
# ==========================================

prod-build: ## Build production Docker images (no migration)
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "üèóÔ∏è  Building Production Images"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "üìù Using GO_VERSION=$(GO_VERSION)"
	@podman-compose -f docker-compose.prod.yml build \
		--build-arg GO_VERSION=$(GO_VERSION)
	@echo "‚úÖ Production images built!"

prod-migrate: ## Run production database migrations (with safety prompt)
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "‚ö†Ô∏è  PRODUCTION DATABASE MIGRATION"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "This will modify the production database schema."
	@echo ""
	@read -p "Continue with production migration? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo "üöÄ Running production migrations..."; \
		GO_VERSION=$(GO_VERSION) podman-compose -f docker-compose.migrate.prod.yml up --abort-on-container-exit; \
		podman-compose -f docker-compose.migrate.prod.yml down; \
		echo "‚úÖ Production migration complete!"; \
	else \
		echo "‚ùå Migration cancelled."; \
		exit 1; \
	fi

prod-backup: ## Create production database backup
	@echo "üíæ Creating production database backup..."
	@mkdir -p backups
	@BACKUP_FILE=backups/backup_$(shell date +%Y%m%d_%H%M%S).sql; \
	podman exec $$(podman ps -q -f name=postgres) pg_dump -U $(POSTGRES_USER) $(POSTGRES_NAME) > $$BACKUP_FILE; \
	echo "‚úÖ Backup created: $$BACKUP_FILE"

prod-deploy: prod-backup prod-migrate prod-build prod-up ## Full production deployment (backup ‚Üí migrate ‚Üí build ‚Üí deploy)
	@echo ""
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "‚úÖ Production Deployment Complete!"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

prod-up: ## Start production services
	@echo "üöÄ Starting production services..."
	@podman-compose -f docker-compose.prod.yml up -d
	@echo "‚è≥ Waiting for services to be healthy..."
	@sleep 10
	@echo "‚úÖ Production services running"

prod-down: ## Stop production services
	@echo "üõë Stopping production services..."
	@podman-compose -f docker-compose.prod.yml down
	@echo "‚úÖ Production services stopped"

prod-logs: ## Show production logs
	@podman-compose -f docker-compose.prod.yml logs -f

prod-status: ## Show production migration status
	@echo "üìä Production Migration Status:"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@podman exec $$(podman ps -q -f name=postgres) psql -U $(POSTGRES_USER) -d $(POSTGRES_NAME) -c \
		"SELECT version, service, description, to_char(applied_at, 'YYYY-MM-DD HH24:MI:SS') as applied \
		 FROM schema_migrations ORDER BY applied_at DESC LIMIT 10;" 2>/dev/null || \
		echo "‚ö†Ô∏è  Cannot connect to production database"

prod-restart: prod-down prod-up ## Restart production services (without rebuild)

prod-rebuild: prod-down prod-build prod-up ## Rebuild and restart production services



# ==========================================
# Cleanup & Deletion
# ==========================================

clean: ## Remove containers, volumes, and temporary files
	@echo "üßπ Cleaning up..."
	@echo "  ‚Üí Stopping and removing dev containers..."
	podman-compose down -v 2>/dev/null || true
	@echo "  ‚Üí Stopping and removing prod containers..."
	podman-compose -f docker-compose.prod.yml down -v 2>/dev/null || true
	@echo "  ‚Üí Removing temporary files..."
	rm -rf app/backend/service-a/tmp app/backend/service-b/tmp app/backend/gateway/tmp
	@echo "  ‚Üí Removing dangling images..."
	podman rmi $$(podman images -f "dangling=true" -q) 2>/dev/null || true
	@echo "‚úÖ Cleanup complete!"

delete: ## Delete ALL containers, images, and system data (DESTRUCTIVE!)
	@bash -c '\
	echo "‚ö†Ô∏è  WARNING: This will delete ALL Podman data!"; \
	read -p "Are you sure? [y/N] " REPLY; \
	if [ "$$REPLY" = "y" ] || [ "$$REPLY" = "Y" ]; then \
		echo "üßπ Deleting all images..."; \
		echo "Stopping all containers..."; \
		podman stop -a; \
		echo "Deleting all stopped containers..."; \
		podman rm -a; \
		echo "Deleting all images..."; \
		podman image prune -a --force; \
		echo "System clean up (networks, volumes, build cache)..."; \
		podman system prune -a --force; \
		echo "‚úÖ Deleted!"; \
	else \
		echo "‚ùå Deletion cancelled."; \
	fi'

delete-vol: ## Delete ALL Podman volumes (DESTRUCTIVE!)
	@bash -c '\
	echo "‚ö†Ô∏è  WARNING: This will delete ALL Podman volumes!"; \
	read -p "Are you sure? [y/N] " REPLY; \
	if [ "$$REPLY" = "y" ] || [ "$$REPLY" = "Y" ]; then \
		echo "üßπ Deleting all volumes..."; \
		podman volume rm $$(podman volume ls -q) 2>/dev/null || true; \
		echo "‚úÖ Volumes deleted!"; \
	else \
		echo "‚ùå Deletion cancelled."; \
	fi'	



# ==========================================
# Database Migration & Status
# ==========================================

db-migrate: ## Run all database migrations
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "üöÄ Starting Database Migration"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "üìù Configuration:"
	@echo "   DB_USER:     $(POSTGRES_USER)"
	@echo "   DB_NAME:     $(POSTGRES_NAME)"
	@echo "   DB_PORT:     $(PORT_POSTGRES)"
	@echo ""
	@echo "üê≥ Starting PostgreSQL and running migrations..."
	@GO_VERSION=$(GO_VERSION) podman-compose -f docker-compose.migrate.yml up --build --abort-on-container-exit
	@echo ""
	@echo "üßπ Cleaning up migration containers..."
	@podman-compose -f docker-compose.migrate.yml down
	@echo ""
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "‚úÖ Migration complete!"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

db-status: ## Show current migration status (requires running DB)
	@echo "üìä Current Migration Status:"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@podman exec $(CONTAINER_POSTGRES) psql -U $(POSTGRES_USER) -d $(POSTGRES_NAME) -c \
		"SELECT version, service, description, direction, to_char(applied_at, 'YYYY-MM-DD HH24:MI:SS') as applied \
		 FROM schema_migrations ORDER BY service, version;" 2>/dev/null || \
		echo "‚ö†Ô∏è  Database container not running. Start it with 'make db-migrate' or 'make dev'"

db-test: ## Full migration test cycle
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "üîç Full Migration Test Cycle"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo ""
	@echo "1Ô∏è‚É£  Starting PostgreSQL..."
	@GO_VERSION=$(GO_VERSION) podman-compose -f docker-compose.migrate.yml up -d postgres
	@echo "‚è≥ Waiting for PostgreSQL to be ready..."
	@sleep 8
	@echo ""
	@echo "2Ô∏è‚É£  Running migrations..."
	@GO_VERSION=$(GO_VERSION) podman-compose -f docker-compose.migrate.yml up --build db-migrator
	@echo ""
	@echo "3Ô∏è‚É£  Validation Results:"
	@echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
	@echo ""
	@echo "üìä Applied Migrations:"
	@podman exec $(CONTAINER_POSTGRES) psql -U $(POSTGRES_USER) -d $(POSTGRES_NAME) -c \
		"SELECT version, service, description, to_char(applied_at, 'YYYY-MM-DD HH24:MI:SS') as applied \
		 FROM schema_migrations ORDER BY service, version;" 2>/dev/null || echo "Failed to query migrations"
	@echo ""
	@echo "üìö Created Tables:"
	@podman exec $(CONTAINER_POSTGRES) psql -U $(POSTGRES_USER) -d $(POSTGRES_NAME) -c "\dt" 2>/dev/null || echo "Failed to list tables"
	@echo ""
	@echo "4Ô∏è‚É£  Cleaning up..."
	@podman-compose -f docker-compose.migrate.yml down
	@echo ""
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "‚úÖ Test complete!"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

db-tables: ## List all database tables (requires running DB)
	@echo "üìö Database Tables:"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@podman exec $(CONTAINER_POSTGRES) psql -U $(POSTGRES_USER) -d $(POSTGRES_NAME) -c "\dt" 2>/dev/null || \
		echo "‚ö†Ô∏è  Database container not running."

db-connect: ## Connect to PostgreSQL shell (requires running DB)
	@echo "üîå Connecting to PostgreSQL..."
	@podman exec -it $(CONTAINER_POSTGRES) psql -U $(POSTGRES_USER) -d $(POSTGRES_NAME)

db-migrations-list: ## List all available migration files
	@echo "üìÅ Available Migration Files:"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@find app/backend/*/db/migrations -name "*.sql" 2>/dev/null | sort || echo "No migrations found"

db-clean: ## ‚ö†Ô∏è  DANGER: Remove database volume (deletes all data!)
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "‚ö†Ô∏è  WARNING: This will DELETE all database data!"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@read -p "Are you absolutely sure? Type 'YES' to confirm: " confirm; \
	if [ "$$confirm" = "YES" ]; then \
		echo "üóëÔ∏è  Removing database volume..."; \
		podman-compose -f docker-compose.migrate.yml down -v; \
		podman-compose -f docker-compose.yml down -v; \
		echo "‚úÖ Database volumes deleted"; \
	else \
		echo "‚ùå Operation cancelled."; \
	fi


db-rollback: ## Rollback last migration (DOWN)
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "‚¨áÔ∏è  Starting Database Rollback (DOWN)"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "‚ö†Ô∏è  WARNING: This will rollback the last migration!"
	@echo ""
	@read -p "Are you sure? Type 'yes' to continue: " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		echo "üìù Configuration:"; \
		echo "   DB_USER:     $(POSTGRES_USER)"; \
		echo "   DB_NAME:     $(POSTGRES_NAME)"; \
		echo "   DB_PORT:     5432"; \
		echo "   Direction:   DOWN"; \
		echo "   Steps:       1"; \
		echo ""; \
		echo "üê≥ Starting PostgreSQL and running rollback..."; \
		MIGRATION_DIRECTION=down ROLLBACK_STEPS=1 GO_VERSION=$(GO_VERSION) podman-compose -f docker-compose.migrate.yml up --build --abort-on-container-exit; \
		echo ""; \
		echo "üßπ Cleaning up migration containers..."; \
		podman-compose -f docker-compose.migrate.yml down; \
		echo ""; \
		echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"; \
		echo "‚úÖ Rollback complete!"; \
		echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"; \
	else \
		echo "‚ùå Rollback cancelled."; \
	fi

db-rollback-all: ## Rollback ALL migrations (DANGEROUS!)
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "‚ö†Ô∏è  DANGER: Rollback ALL Migrations"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "‚ö†Ô∏è  WARNING: This will rollback ALL migrations!"
	@echo "‚ö†Ô∏è  This will DELETE all your database schema!"
	@echo ""
	@read -p "Are you ABSOLUTELY SURE? Type 'ROLLBACK ALL' to continue: " confirm; \
	if [ "$$confirm" = "ROLLBACK ALL" ]; then \
		echo "üìù Configuration:"; \
		echo "   DB_USER:     $(POSTGRES_USER)"; \
		echo "   DB_NAME:     $(POSTGRES_NAME)"; \
		echo "   Direction:   DOWN"; \
		echo "   Mode:        ALL"; \
		echo ""; \
		echo "üê≥ Starting PostgreSQL and running full rollback..."; \
		MIGRATION_DIRECTION=down ROLLBACK_ALL=true GO_VERSION=$(GO_VERSION) podman-compose -f docker-compose.migrate.yml up --build --abort-on-container-exit; \
		echo ""; \
		echo "üßπ Cleaning up migration containers..."; \
		podman-compose -f docker-compose.migrate.yml down; \
		echo ""; \
		echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"; \
		echo "‚úÖ Full rollback complete!"; \
		echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"; \
	else \
		echo "‚ùå Rollback cancelled."; \
	fi



.PHONY: db-migrate db-rollback db-rollback-all db-status db-test db-connect db-tables db-migrations-list db-clean db-rollback





# ==========================================
# Metrics & Logs
# ==========================================

stat: ## Show Podman images and running containers
	@echo "üîç Podman Status"
	@echo ""
	@echo "üì¶ Images:"
	@podman images
	@echo ""
	@echo "üèÉ Running Containers:"
	@podman ps
	@echo ""
	@echo "üí§ All Containers:"
	@podman ps -a

info: ## Show Podman system information
	@echo "üîç Podman System Information"
	@podman info

storage: ## Show Podman storage usage
	@echo "üíæ Storage Usage"
	@podman system df

logs: ## Show logs from all development services
	@echo "üìã Showing logs (Ctrl+C to exit)..."
	podman-compose logs -f

logs-a: ## Show logs from service-a only
	@echo "üìã Showing service-a logs (Ctrl+C to exit)..."
	podman-compose logs -f service-a

logs-b: ## Show logs from service-b only
	@echo "üìã Showing service-b logs (Ctrl+C to exit)..."
	podman-compose logs -f service-b

logs-g: ## Show logs from gateway only
	@echo "üìã Showing gateway logs (Ctrl+C to exit)..."
	podman-compose logs -f gateway

check: fmt lint test ## Run all checks (format, lint, test)
	@echo "‚úÖ All checks passed!"

ci: init check ## Run CI pipeline locally
	@echo "‚úÖ CI pipeline complete!"

logs-grafana: ## Open Grafana in browser
	@echo "üîç Opening Grafana..."
	@echo "URL: http://localhost:3000"
	@echo "Login: admin / admin"
	@xdg-open http://localhost:3000 2>/dev/null || open http://localhost:3000 2>/dev/null || echo "Open manually: http://localhost:3000"

logs-loki: ## Show Loki logs
	@echo "üìã Showing Loki logs..."
	podman-compose logs -f loki