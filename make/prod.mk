# ==========================================
# Production Commands
# ==========================================

.PHONY: prod-build prod-migrate prod-backup prod-deploy prod-up prod-down prod-logs prod-status prod-restart prod-rebuild

prod-build: ## Build production Docker images (no migration)
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "üèóÔ∏è ¬†Building Production Images"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "üìù Using GO_VERSION=$(GO_VERSION)"
	@podman-compose -f docker-compose.prod.yml build \
		--build-arg GO_VERSION=$(GO_VERSION)
	@echo "‚úÖ Production images built!"

prod-migrate: ## Run production database migrations (with safety prompt)
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "‚ö†Ô∏è ¬†PRODUCTION DATABASE MIGRATION"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "üìù Configuration:"
	@echo "   DB_USER:     $(POSTGRES_USER)"
	@echo "   DB_NAME:     $(POSTGRES_NAME)"
	@echo "   DB_PORT:     $(PORT_POSTGRES)"
	@echo "   Direction:   UP"
	@echo ""
	@echo "This will modify the production database schema."
	@echo ""
	@read -p "Continue with production migration? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo "üöÄ Running production migrations..."; \
		MIGRATION_DIRECTION=up GO_VERSION=$(GO_VERSION) podman-compose -f docker-compose.migrate.prod.yml up --abort-on-container-exit; \
		podman-compose -f docker-compose.migrate.prod.yml down; \
		echo "‚úÖ Production migration complete!"; \
	else \
		echo "‚ùå Migration cancelled."; \
		exit 1; \
	fi

prod-backup: ## Create production database backup
	@echo "üíæ Creating production database backup..."
	@mkdir -p backups
	@BACKUP_FILE=backups/backup_$(shell date +%Y%m%d_%H%M%S).sql; \
	podman exec $$(podman ps -q -f name=postgres) pg_dump -U $(POSTGRES_USER) $(POSTGRES_NAME) > $$BACKUP_FILE; \
	echo "‚úÖ Backup created: $$BACKUP_FILE"

prod-deploy: prod-backup prod-migrate prod-build prod-up ## Full production deployment (backup ‚Üí migrate ‚Üí build ‚Üí deploy)
	@echo ""
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "‚úÖ Production Deployment Complete!"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

prod-up: ## Start production services
	@echo "üöÄ Starting production services..."
	@podman-compose -f docker-compose.prod.yml up -d
	@echo "‚è≥ Waiting for services to be healthy..."
	@sleep 10
	@echo "‚úÖ Production services running"

prod-down: ## Stop production services
	@echo "üõë Stopping production services..."
	@podman-compose -f docker-compose.prod.yml down
	@echo "‚úÖ Production services stopped"

prod-logs: ## Show production logs
	@podman-compose -f docker-compose.prod.yml logs -f

prod-status: ## Show production migration status
	@echo "üìä Production Migration Status:"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@podman exec $$(podman ps -q -f name=postgres) psql -U $(POSTGRES_USER) -d $(POSTGRES_NAME) -c \
		"SELECT version, service, description, to_char(applied_at, 'YYYY-MM-DD HH24:MI:SS') as applied \
		FROM schema_migrations ORDER BY applied_at DESC LIMIT 10;" 2>/dev/null || \
		echo "‚ö†Ô∏è ¬†Cannot connect to production database"

prod-restart: prod-down prod-up ## Restart production services (without rebuild)

prod-rebuild: prod-down prod-build prod-up ## Rebuild and restart production services

